#2
FROM ubuntu:latest

# Maintainer metadata
LABEL maintainer="devsecops.club@gmail.com"
LABEL version="1.1"
LABEL description="An Ubuntu-based image with OpenJDK 24, Maven, and Tomcat 10 installed"

# Set environment variables for Maven, Tomcat, and OpenJDK
ENV DEBIAN_FRONTEND=noninteractive \
    MAVEN_VERSION=3.9.11 \  
    TOMCAT_VERSION=10.1.43 \
    MAVEN_HOME=/usr/local/maven \
    JAVA_HOME=/usr/local/openjdk-24 \
    PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/local/maven/bin:/usr/local/openjdk-24/bin

# Update the package manager and install necessary dependencies
RUN apt-get update && apt-get install -y \
    wget \
    tar \
    git \
    && rm -rf /var/lib/apt/lists/*

# Download and install OpenJDK 24
RUN wget -q "https://download.java.net/java/GA/jdk24/1f9ff9062db4449d8ca828c504ffae90/36/GPL/openjdk-24_linux-aarch64_bin.tar.gz" -O /tmp/openjdk.tar.gz \
    && mkdir -p $JAVA_HOME \
    && tar -xzf /tmp/openjdk.tar.gz -C $JAVA_HOME --strip-components=1 \
    && rm /tmp/openjdk.tar.gz

# Download and install Maven
RUN wget -q "https://dlcdn.apache.org/maven/maven-3/${MAVEN_VERSION}/binaries/apache-maven-${MAVEN_VERSION}-bin.tar.gz" -O /tmp/maven.tar.gz \
    && mkdir -p $MAVEN_HOME \
    && tar -xzf /tmp/maven.tar.gz -C $MAVEN_HOME --strip-components=1 \
    && rm /tmp/maven.tar.gz

# Download and install Tomcat
RUN wget -q "https://dlcdn.apache.org/tomcat/tomcat-10/v${TOMCAT_VERSION}/bin/apache-tomcat-${TOMCAT_VERSION}.tar.gz" -O /tmp/tomcat.tar.gz \
    && mkdir -p /usr/local/tomcat \
    && tar -xzf /tmp/tomcat.tar.gz -C /usr/local/tomcat --strip-components=1 \
    && rm /tmp/tomcat.tar.gz

# Verify Maven and Java installations
RUN echo "PATH: $PATH" \
    && echo "JAVA_HOME: $JAVA_HOME" \
    && echo "MAVEN_HOME: $MAVEN_HOME" \
    && mvn -v \
    && java -version

# Clone the Maven project into the container
RUN git clone https://github.com/dsoc3/DSOC3-WebApp.git /tmp/DSOC3-WebApp

# Change to the project directory and build the Maven project
WORKDIR /tmp/DSOC3-WebApp
RUN mvn clean install

# Copy the generated WAR file to the Tomcat webapps directory
RUN cp target/*.war /usr/local/tomcat/webapps/

# Expose Tomcat port
EXPOSE 8080

# Set working directory to Tomcat home
WORKDIR /usr/local/tomcat

# Command to start Tomcat
CMD ["bin/catalina.sh", "run"]

#http://localhost:8080/dsoc3-webapp/
